

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using an image splitting device for multi-colour ratiometric imaging &mdash; PYME 20.02.12 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="PSF Extraction" href="PSFExtraction.html" />
    <link rel="prev" title="Analysing data not generated by PYMEAcquire" href="AnalysingForeignData.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> PYME
          

          
            
            <img src="_static/pymeLogo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                20.02.12
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Installation/InstallationWithAnaconda.html">Installation of PYME on 64 bit Windows, OSX, or Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="Installation/InstallationFromSource.html">Installation for development or instrument control</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="PYMEAcquire.html"><strong>PYMEAcquire</strong> - Instrument control and simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Analysis.html"><strong>dh5view</strong> - Image Data Analysis and Viewing</a></li>
<li class="toctree-l1"><a class="reference internal" href="VisGUI.html"><strong>VisGUI</strong> - Visualising Localization Data Sets</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="component_programs.html">Common Tasks</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="LocalisationAnalysis.html">Analysing Localisation Microscopy data</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="AnalysingForeignData.html">Analysing data not generated by PYMEAcquire</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Using an image splitting device for multi-colour ratiometric imaging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#calibrating-the-image-splitting-device">Calibrating the image splitting device</a></li>
<li class="toctree-l4"><a class="reference internal" href="#analysing-ratiometric-images">Analysing ratiometric images</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualising-ratiometric-data">Visualising ratiometric data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="LocalisationAnalysis.html#starting-distributed-analysis-infrastructure">Starting distributed analysis infrastructure</a></li>
<li class="toctree-l3"><a class="reference internal" href="LocalisationAnalysis.html#loading-data">Loading data</a></li>
<li class="toctree-l3"><a class="reference internal" href="LocalisationAnalysis.html#analysis-settings">Analysis settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="LocalisationAnalysis.html#starting-the-fitting">Starting the fitting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="PSFExtraction.html">PSF Extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="Recipes.html">Using recipes for data processing and quantification</a></li>
<li class="toctree-l2"><a class="reference internal" href="howtos/distancecolocalization.html">Distance transform colocalization HOWTO</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="LocalisationAnalysis.html">Analysing Localisation Microscopy data</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="AnalysingForeignData.html">Analysing data not generated by PYMEAcquire</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using an image splitting device for multi-colour ratiometric imaging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#calibrating-the-image-splitting-device">Calibrating the image splitting device</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#large-shifts">Large shifts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#analysing-ratiometric-images">Analysing ratiometric images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visualising-ratiometric-data">Visualising ratiometric data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="LocalisationAnalysis.html#starting-distributed-analysis-infrastructure">Starting distributed analysis infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="LocalisationAnalysis.html#loading-data">Loading data</a></li>
<li class="toctree-l2"><a class="reference internal" href="LocalisationAnalysis.html#analysis-settings">Analysis settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="LocalisationAnalysis.html#starting-the-fitting">Starting the fitting</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Development / Hacking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hacking.html">Extending PYME and writing plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="hacking.html#technical-details">Technical Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="hacking.html#api-documentation">API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PYME</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="component_programs.html">Common Tasks</a> &raquo;</li>
        
          <li><a href="LocalisationAnalysis.html">Analysing Localisation Microscopy data</a> &raquo;</li>
        
      <li>Using an image splitting device for multi-colour ratiometric imaging</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-an-image-splitting-device-for-multi-colour-ratiometric-imaging">
<span id="imagesplitter"></span><h1>Using an image splitting device for multi-colour ratiometric imaging<a class="headerlink" href="#using-an-image-splitting-device-for-multi-colour-ratiometric-imaging" title="Permalink to this headline">¶</a></h1>
<div class="section" id="calibrating-the-image-splitting-device">
<h2>Calibrating the image splitting device<a class="headerlink" href="#calibrating-the-image-splitting-device" title="Permalink to this headline">¶</a></h2>
<p>These instructions are designed for use with an image splitting device and a single CCD camera. They should be able to be applied to a multi-camera scenario if the images are stiched together first. The code was originally written for a home-built splitter where the CCD was split vertically and the two halves were mirror image views. It has since been modified to work with more generic splitters, although these modifications are not yet well tested (we’re currently in the process of assembling a new splitter which split’s horizontally and doesn’t flip, so any bugs are likely to be ironed out over the course of the next couple of weeks).</p>
<ol class="arabic simple">
<li>Prepare a medium density bead slide (minimum separation between beads should be on the order of ~ 500 nm, more is OK). The density should be low enough that beads in both channels can be unambiguously assigned (i.e. there should only be one bead in any given 15x15 pixel ROI), a small number of clusters is permissible as these will be discarded in post-processing. A suitable density usually works out at ~20 beads in the field of view (our FOV is half the camera).</li>
<li>Because the density used above is relatively low, a single image will not give us a particularly good estimate of the vector shift field between the two channels. To enable a better coverage of the field of view we take multiple shifted images of the beads, achieving better coverage through post-processing. If using PYMEAcquire for data acquisition on a microscope with a motorised stage there is a protocol (called ‘shiftfield’) which will do this for you. If using 3rd party software, or using a microscope without a motorised stage you can simply move the stage manually whilst recording a sequence of images (the analysed data is filtered for bead width and blurred beads will be discarded – I find a series of short moves with brief pauses to be effective).</li>
<li>Make sure that the distributed data analysis platform (<code class="docutils literal notranslate"><span class="pre">launchWorkers</span></code>) is running.</li>
<li>Open the data using <code class="docutils literal notranslate"><span class="pre">dh5view</span></code> (if using PYMEAcquire it should open automatically).</li>
<li>From the <em>‘Set defaults for’</em> menu chose <em>‘Calibrating the splitter’</em>. This sets the fit model to one in which the separation between red and green images of the same bead is a free parameter. It also turns off temporal background subtraction and increases the detection threshold.</li>
<li><strong>[Non-PYME data only]</strong> If the data was acquired in 3rd party software you will also need to set a number of metadata parameters to tell the software about how the splitting is carried out (these can be entered from the console within <code class="docutils literal notranslate"><span class="pre">dh5view</span></code>, but it might make more sense to put them in the .md file used to get the data to load – see the loading external data bit of the PYME documentation). The relevant parameters are <code class="docutils literal notranslate"><span class="pre">Splitter.Channel0ROI</span></code>, <code class="docutils literal notranslate"><span class="pre">Splitter.Channel1ROI</span></code>, and <code class="docutils literal notranslate"><span class="pre">Splitter.Flip</span></code>. The ROI parameters take a list of values in the form <code class="docutils literal notranslate"><span class="pre">[x0,</span> <span class="pre">y0,</span> <span class="pre">width,</span> <span class="pre">height]</span></code>. The Flip parameter is either <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>. It is important that the width and height is the same for both ROIs. Eg (if entered in the .md file – if executed at the console, replace <code class="docutils literal notranslate"><span class="pre">md</span></code> with <code class="docutils literal notranslate"><span class="pre">image.mdh</span></code>)</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;Splitter.Channel0ROI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">]</span>
<span class="n">md</span><span class="p">[</span><span class="s1">&#39;Splitter.Channel1ROI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">]</span>
<span class="n">md</span><span class="p">[</span><span class="s1">&#39;Splitter.Flip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li>Click on <em>‘Test’</em> to see if the detection threshold is suitable – if necessary try a higher or lower threshold.</li>
<li>Once happy with the threshold, click <em>‘Go’</em>. This will send the frames into the distributed analysis system which should churn through and perform the fits <a class="footnote-reference" href="#id3" id="id1">[1]</a>.</li>
<li>One all the analysis tasks are complete, go to the analysis folder (if you haven’t set the <code class="docutils literal notranslate"><span class="pre">PYMEDataDir</span></code> environment varible it should be under <code class="docutils literal notranslate"><span class="pre">c:\Users\&lt;username&gt;\PYMEData\Analysis\&lt;name</span> <span class="pre">of</span> <span class="pre">folder</span> <span class="pre">containing</span> <span class="pre">raw</span> <span class="pre">data&gt;</span></code>) and find the <code class="docutils literal notranslate"><span class="pre">.h5r</span></code> file corresponding to the raw data. Open this in <code class="docutils literal notranslate"><span class="pre">VisGUI</span></code>.</li>
<li>Check the data in <code class="docutils literal notranslate"><span class="pre">VisGUI</span></code> to see if it looks reasonable - good coverage of the field of view, reasonable looking distribution of shifts if you set the point colour to be <code class="docutils literal notranslate"><span class="pre">FitResults_dx</span></code> or <code class="docutils literal notranslate"><span class="pre">FitResults_dy</span></code> (the x and y shifts). Try adjusting the filter if this is not the case (a good place to start is sigma – the PSF std deviation, which can be set to a reasonably narrow window around the expected bead width). A few erroneous vectors are still permissible as these will be filtered out in subsequent steps.</li>
<li>From the <em>‘Extras’</em> menu choose <em>‘Calculate shiftmap’</em>. This will attempt to interpolate the shift vectors obtained at the bead locations across the field of view. The algorithm first checks to see if each vector points in approximately the same direction as it’s neighbours. ‘Wonky’ vectors which dramatically differ from their neighbours but have somehow made if through prior filtering steps are discarded at this point. Bivariate smoothing splines are then fitted to the x and y shift vectors. The resulting interpolated shift field (and residuals) is shown, and the user given the opportunity to save the shiftmap (effectively the spline coefficients) in a .sf file. Unfortunately the ‘save’ dialog is modal and you don’t get a chance to examine the shift field before being prompted to save. I usually cancel the save request the first time, examine the result, and if happy, run <em>‘Calculate shiftmap’</em> again, saving the result. This interpolated shift field should be smooth, although it’s common to see magnification differences as well as rotation in the field resulting in a spiral or vortex like appearance. If you’re unhappy with the generated shiftmap, you can go back to the filter (or if really bad try acquiring and analysing a new data set).</li>
</ol>
<blockquote>
<div><strong>New</strong>: If the above does not yield a good shiftmap (shifts should be mostly translation, rotation, and some scaling, which results in smoothly varying shiftmaps) you can also try the <em>‘Calculate Shiftmap (Model Based)’</em> option (also on the <em>‘Extras’</em> menu) which fits the coefficients of a global affine transform rather than trying to interpolate shifts. The resulting shiftmap will be less flexible than one calculated using the <em>‘Calculate shiftmap’</em> function, but captures the most likely transformations and is better behaved (particularly at the corners of the field where errors can be common).</div></blockquote>
<div class="section" id="large-shifts">
<h3>Large shifts<a class="headerlink" href="#large-shifts" title="Permalink to this headline">¶</a></h3>
<p>If you have very large shifts, you might need to increase the size of the ROI used to fit each bead when performing the callibration. This can be achieved by overriding the <code class="docutils literal notranslate"><span class="pre">ROISize</span></code> parameter in the analysis - e.g. by entering:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">image</span><span class="o">.</span><span class="n">mdh</span><span class="p">[</span><span class="s1">&#39;Analysis.ROISize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
<p>in the <code class="docutils literal notranslate"><span class="pre">dh5view</span></code> console. The <code class="docutils literal notranslate"><span class="pre">ROISize</span></code> setting is the size of a ‘half ROI’, with the size of the actual ROI being <span class="math notranslate nohighlight">\(2n + 1\)</span>. The default for shift estimation is 7 (15x15), and the default for fitting is 5 (11x11).</p>
</div>
</div>
<div class="section" id="analysing-ratiometric-images">
<h2>Analysing ratiometric images<a class="headerlink" href="#analysing-ratiometric-images" title="Permalink to this headline">¶</a></h2>
<p>Whilst not as complicated as the calibration procedure, the analysis procedure for multi-colour images is also a little different to that for single colour images.</p>
<ol class="arabic simple">
<li>Load the data in dh5view</li>
<li>Choose <code class="docutils literal notranslate"><span class="pre">SplitterFitFNR</span></code> as the fit module (<strong>Note:</strong> this assumes that the default temporal background subtraction has done it’s thing and doesn’t fit the background at all. If you have disabled background subtraction, try using the older <code class="docutils literal notranslate"><span class="pre">SplitterFitFR</span></code>) <a class="footnote-reference" href="#id4" id="id2">[2]</a>.</li>
<li>Set the Splitter parameters as in 6 above</li>
<li>Set the shift field to the .sf file saved in the calibration step (click on the ‘Set’ button)</li>
<li>Test the threshold</li>
<li>Click ‘Go’ to start the analysis.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The shifts are corrected as part of the fitting process (they should be absent from the fitted data)</p>
</div>
</div>
<div class="section" id="visualising-ratiometric-data">
<h2>Visualising ratiometric data<a class="headerlink" href="#visualising-ratiometric-data" title="Permalink to this headline">¶</a></h2>
<p>If you have analysed data using one of the <em>‘SplitterFit…’</em> modules, VisGUI will show a colour tab with a scattergram of the ratios. Before you can render the images as multi-colour, you will need to add species to this scattergram by clicking add and setting the ratio (which can then be tweaked by clicking on the ratio value in the table). You can also try and automagically guess what components are present by using the ‘Guess’ button. The points assigned to a certain ratio will be given the same colour as that component. After the ratios have been defined, you will have new selections in the colour filter selector in the main window, and rendering options will default to producing multi-channel images.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is also possible to define species and ratios in the metadata, but that is beyond the scope of what we can go into here.</p>
</div>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Extra for experts:  in this case it will probably only make use of 1 or 2 cores as the distributed analysis uses a chunk size of at least 50 frames to allow the data to be cached for efficient background subtraction on the workers when analysing binking datasets.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><code class="docutils literal notranslate"><span class="pre">SplitterFitFNR</span></code> is a new routine and is preferred as it performs shift-corrected ROI extraction and thus works for larger shift values. The previous versions only worked if the shift was sufficently small that the ROI co-ordinates for the 1st channel could also be used to extract a ROI for the second channel which completely enclosed the 2nd image of a molecule. As well as coping with almost arbitrarily large shifts, the new routine allows a smaller ROI to be used for moderate shifts, improving speed and tolerable localisation density.</td></tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="PSFExtraction.html" class="btn btn-neutral float-right" title="PSF Extraction" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="AnalysingForeignData.html" class="btn btn-neutral float-left" title="Analysing data not generated by PYMEAcquire" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, David Baddeley

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>